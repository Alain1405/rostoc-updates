name: Staple Notarized DMGs

on:
    schedule:
        # Run every 30 minutes
        - cron: "*/30 * * * *"
    workflow_dispatch:

permissions:
    contents: write

jobs:
    staple-and-upload:
        runs-on: macos-latest
        env:
            PRIVATE_REPO: Alain1405/rostoc
        steps:
            - name: Setup SSH agent for private repo
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.PRIVATE_REPO_SSH_KEY }}

            - name: Add GitHub to known_hosts
              run: |
                  mkdir -p ~/.ssh
                  ssh-keyscan github.com >> ~/.ssh/known_hosts

            - name: Checkout private repo
              uses: actions/checkout@v4
              with:
                  repository: ${{ env.PRIVATE_REPO }}
                  ssh-key: ${{ secrets.PRIVATE_REPO_SSH_KEY }}
                  path: private-src

            - name: Process pending notarizations
              working-directory: private-src
              env:
                  APPLE_ID: ${{ secrets.APPLE_ID }}
                  APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
                  APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
                  GH_TOKEN: ${{ secrets.UPDATES_REPO_TOKEN }}
              run: |
                  # Script now reads from releases.json on GitHub Pages
                  # No artifact download needed!
                  bash scripts/macos/staple_and_upload_dmg.sh
