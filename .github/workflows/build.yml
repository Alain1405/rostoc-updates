name: Build Desktop (Reusable)

on:
  workflow_call:
    inputs:
      ref:
        required: true
        type: string
        description: 'Git reference to build (branch, tag, or commit SHA)'
      commit_sha:
        required: false
        type: string
        description: 'Commit SHA for status updates (defaults to github.sha)'
      is_release:
        required: false
        type: boolean
        default: false
        description: 'Whether this is a release build'

env:
  PRIVATE_REPO: alain1405/rostoc
  UPDATES_DIR: updates
  VERSION_FILE: version.txt

jobs:
  build-desktop:
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(inputs.is_release && '[{"variant":"production","os":"macos-15","platform":"macos","arch":"aarch64","name":"macOS ARM64 (M1)","is_optional":false},{"variant":"production","os":"windows-2022","platform":"windows","arch":"x86_64","name":"Windows x64","is_optional":false},{"variant":"production","os":"macos-15-intel","platform":"macos","arch":"x86_64","name":"macOS Intel x86-64","is_optional":true},{"variant":"production","os":"windows-2022","platform":"windows","arch":"i686","name":"Windows x86 (32-bit)","is_optional":true},{"variant":"production","os":"ubuntu-latest","platform":"linux","arch":"x86_64","name":"Linux AppImage x86-64","is_optional":true},{"variant":"staging","os":"macos-15","platform":"macos","arch":"aarch64","name":"macOS ARM64 (M1) — Staging","is_optional":false},{"variant":"staging","os":"windows-2022","platform":"windows","arch":"x86_64","name":"Windows x64 — Staging","is_optional":false},{"variant":"staging","os":"macos-15-intel","platform":"macos","arch":"x86_64","name":"macOS Intel x86-64 — Staging","is_optional":true},{"variant":"staging","os":"windows-2022","platform":"windows","arch":"i686","name":"Windows x86 (32-bit) — Staging","is_optional":true},{"variant":"staging","os":"ubuntu-latest","platform":"linux","arch":"x86_64","name":"Linux AppImage x86-64 — Staging","is_optional":true}]' || '[{"variant":"production","os":"macos-15","platform":"macos","arch":"aarch64","name":"macOS ARM64 (M1)","is_optional":false},{"variant":"production","os":"windows-2022","platform":"windows","arch":"x86_64","name":"Windows x64","is_optional":false},{"variant":"production","os":"macos-15-intel","platform":"macos","arch":"x86_64","name":"macOS Intel x86-64","is_optional":true},{"variant":"production","os":"windows-2022","platform":"windows","arch":"i686","name":"Windows x86 (32-bit)","is_optional":true},{"variant":"production","os":"ubuntu-latest","platform":"linux","arch":"x86_64","name":"Linux AppImage x86-64","is_optional":true}]') }}

    runs-on: ${{ matrix.os }}
    # Optional jobs continue even if they fail
    continue-on-error: ${{ matrix.is_optional }}

    env:
      SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
      SENTRY_SEND_DEFAULT_PII: ${{ secrets.SENTRY_SEND_DEFAULT_PII }}
      SENTRY_ENVIRONMENT: ${{ inputs.is_release && 'production' || 'ci' }}
      VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}
      VITE_SENTRY_SEND_DEFAULT_PII: ${{ secrets.VITE_SENTRY_SEND_DEFAULT_PII }}
      VITE_SENTRY_ENVIRONMENT: ${{ inputs.is_release && 'production' || 'ci' }}
      ROSTOC_APP_VARIANT: ${{ matrix.variant }}
      ROSTOC_UPDATE_CHANNEL: ${{ matrix.variant == 'staging' && 'staging' || 'stable' }}
      DO_RELEASE_PREFIX: ${{ matrix.variant == 'staging' && 'releases/staging' || 'releases' }}
    timeout-minutes: ${{ matrix.platform == 'linux' && 30 || 50 }}
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
      platform: ${{ matrix.platform }}
      arch: ${{ matrix.arch }}

    steps:
      - name: Checkout repo (actions + workflows)
        uses: actions/checkout@v4

      # --- Phase 1: Prep (checkout, SSH, toolchains) ---
      - uses: ./.github/actions/build-prep
        id: prep
        with:
          ref: ${{ inputs.ref }}
          is_release: ${{ inputs.is_release }}
          platform: ${{ matrix.platform }}
          arch: ${{ matrix.arch }}
          private_repo_ssh_key: ${{ secrets.PRIVATE_REPO_SSH_KEY }}
          apple_certificate: ${{ secrets.APPLE_CERTIFICATE }}
          apple_certificate_password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          apple_signing_identity: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          apple_team_id: ${{ secrets.APPLE_TEAM_ID }}
          apple_id: ${{ secrets.APPLE_ID }}
          apple_app_specific_password: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}

      # --- Phase 2: Compile (Python, build, stage) ---
      - uses: ./.github/actions/build-compile
        id: compile
        with:
          platform: ${{ matrix.platform }}
          arch: ${{ matrix.arch }}
          is_release: ${{ inputs.is_release }}
          apple_signing_identity: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          apple_team_id: ${{ secrets.APPLE_TEAM_ID }}
          apple_id: ${{ secrets.APPLE_ID }}
          apple_app_specific_password: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          tauri_signing_private_key: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          tauri_signing_private_key_password: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      # --- Upload build logs (even on failure) ---
      - name: Upload build logs (pre-tests)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-pre-tests-${{ matrix.variant }}-${{ matrix.platform }}-${{ matrix.arch }}
          path: private-src/build-${{ matrix.platform }}-${{ matrix.arch }}.log
          retention-days: 7
          if-no-files-found: warn

      # --- Phase 3: Sign & Validate (macOS-specific) ---
      - uses: ./.github/actions/build-sign-validate
        id: sign_validate
        with:
          platform: ${{ matrix.platform }}
          arch: ${{ matrix.arch }}
          apple_signing_identity: ${{ secrets.APPLE_SIGNING_IDENTITY }}

      # --- Phase 4: Tests (smoke tests for all platforms) ---
      - uses: ./.github/actions/build-tests
        id: tests
        with:
          variant: ${{ matrix.variant }}
          platform: ${{ matrix.platform }}
          arch: ${{ matrix.arch }}
          app_path: ${{ steps.sign_validate.outputs.app_path }}
          python_path: ${{ steps.sign_validate.outputs.python_path }}

      # --- Phase 5: Artifacts (locate, prepare, upload) ---
      - uses: ./.github/actions/build-artifacts
        id: artifacts
        with:
          platform: ${{ matrix.platform }}
          arch: ${{ matrix.arch }}
          is_release: ${{ inputs.is_release }}
          variant: ${{ matrix.variant }}
          version: ${{ steps.prep.outputs.version }}
          updates_repo_token: ${{ secrets.UPDATES_REPO_TOKEN }}
          do_spaces_access_key: ${{ secrets.DO_SPACES_ACCESS_KEY }}
          do_spaces_secret_key: ${{ secrets.DO_SPACES_SECRET_KEY }}
          do_spaces_bucket: ${{ secrets.DO_SPACES_BUCKET }}
          do_spaces_endpoint: ${{ secrets.DO_SPACES_ENDPOINT }}

      # --- Export version for downstream jobs ---
      - name: Export version
        id: extract_version
        shell: bash
        run: echo "version=${{ steps.prep.outputs.version }}" >> "$GITHUB_OUTPUT"
