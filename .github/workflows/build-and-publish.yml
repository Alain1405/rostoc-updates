name: Build & Publish (Orchestrator)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git reference to build (branch, tag, or commit SHA)'
        required: true
        type: string

  workflow_call:
    inputs:
      ref:
        required: true
        type: string
        description: 'Git reference to build'
      commit_sha:
        required: false
        type: string
        description: 'Commit SHA for status updates'
      is_release:
        required: false
        type: boolean
        default: false
        description: 'Whether this is a release build'
      release_channel:
        required: false
        type: string
        default: 'stable'
        description: 'Release channel (stable, beta, dev)'
      backend_publish_url:
        required: false
        type: string
        default: 'https://api.rostoc.co/api/updates/publish/'
        description: 'Backend API endpoint for release publishing'

permissions:
  contents: write
  pages: write
  id-token: write
  actions: write

env:
  PRIVATE_REPO: alain1405/rostoc

jobs:
  # Phase 1: Setup & validation (set-status, lint-and-tests)
  setup:
    uses: ./.github/workflows/setup.yml
    with:
      ref: ${{ inputs.ref }}
      commit_sha: ${{ inputs.commit_sha || github.sha }}
      is_release: ${{ inputs.is_release || false }}
    secrets: inherit

  # Phase 2: Build desktop (matrix: macOS M1, Windows x64, + optional platforms)
  build:
    needs: setup
    uses: ./.github/workflows/build.yml
    with:
      ref: ${{ inputs.ref }}
      commit_sha: ${{ inputs.commit_sha || github.sha }}
      is_release: ${{ inputs.is_release || false }}
    secrets: inherit

  # Phase 3: Publish (generate-releases-json, publish-to-pages)
  publish:
    if: inputs.is_release
    needs: build
    uses: ./.github/workflows/publish.yml
    with:
      ref: ${{ inputs.ref }}
      commit_sha: ${{ inputs.commit_sha || github.sha }}
      is_release: true
      release_channel: ${{ inputs.release_channel || 'stable' }}
      backend_publish_url: ${{ inputs.backend_publish_url || 'https://api.rostoc.co/api/updates/publish/' }}
    secrets: inherit

  # Phase 4: Finalize (update commit status)
  finalize:
    if: always()
    needs: [build, publish]
    uses: ./.github/workflows/finalize.yml
    with:
      commit_sha: ${{ inputs.commit_sha || github.sha }}
      is_release: ${{ inputs.is_release || false }}
      build_result: ${{ needs.build.result }}
    secrets: inherit
