name: Publish to Pages (Reusable)

on:
  workflow_call:
    inputs:
      ref:
        required: true
        type: string
        description: 'Git reference for source repo (for fetching manifest generation scripts)'
      is_release:
        required: false
        type: boolean
        default: false
        description: 'Whether this is a release build'
      release_channel:
        required: false
        type: string
        default: 'stable'
        description: 'Release channel (stable, beta, dev)'
      commit_sha:
        required: false
        type: string
        description: 'Commit SHA for backend publishing'
      backend_publish_url:
        required: false
        type: string
        default: 'https://api.rostoc.co/api/updates/publish/'
        description: 'Backend API endpoint for release publishing'

env:
  PRIVATE_REPO: Rostoc/rostoc
  UPDATES_DIR: updates
  VERSION_FILE: version.txt

jobs:
  generate-releases-json:
    if: inputs.is_release
    runs-on: ubuntu-22.04
    env:
      RELEASE_CHANNEL: ${{ inputs.release_channel || 'stable' }}
      BACKEND_PUBLISH_URL: ${{ inputs.backend_publish_url || 'https://api.rostoc.co/api/updates/publish/' }}
      BUILD_SHA: ${{ inputs.commit_sha || github.sha }}
      DO_SPACES_CDN_URL: ${{ secrets.DO_SPACES_CDN_URL || 'https://rostoc-releases.sgp1.cdn.digitaloceanspaces.com' }}
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
    steps:
      - name: Checkout updates repo
        uses: actions/checkout@v4
        with:
          ref: main # Always use latest scripts, regardless of triggering ref

      - name: Checkout main source repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.PRIVATE_REPO }}
          ref: ${{ inputs.ref }}
          ssh-key: ${{ secrets.PRIVATE_REPO_SSH_KEY }}
          path: private-src

      - name: Download all release artifacts for channel
        uses: actions/download-artifact@v4
        with:
          pattern: ${{ inputs.release_channel == 'staging' && 'rostoc-updates-staging-*' || 'rostoc-updates-stable-*' }}
          path: artifacts
          merge-multiple: true

      - name: Debug - List downloaded artifacts
        run: |
          echo "=== Artifacts directory structure (top-level) ==="
          ls -la artifacts/ || echo "artifacts/ directory not found"
          echo ""
          echo "=== Full recursive listing ==="
          find artifacts/ -type f -o -type d | sort || echo "find failed"
          echo ""
          echo "=== Checking for platform subdirectories ==="
          ls -la artifacts/macos/ 2>/dev/null && echo "✓ artifacts/macos/ exists" || echo "✗ artifacts/macos/ not found"
          ls -la artifacts/windows/ 2>/dev/null && echo "✓ artifacts/windows/ exists" || echo "✗ artifacts/windows/ not found"
          ls -la artifacts/linux/ 2>/dev/null && echo "✓ artifacts/linux/ exists" || echo "✗ artifacts/linux/ not found"
          ls -la artifacts/updates/ 2>/dev/null && echo "✓ artifacts/updates/ exists" || echo "✗ artifacts/updates/ not found"
          echo ""
          echo "=== Artifact names that were downloaded (based on pattern) ==="
          echo "Pattern used: ${{ inputs.release_channel == 'staging' && 'rostoc-updates-staging-*' || 'rostoc-updates-stable-*' }}"
          echo "Expected artifacts:"
          echo "  - rostoc-updates-${{ inputs.release_channel || 'stable' }}-macos-aarch64"
          echo "  - rostoc-updates-${{ inputs.release_channel || 'stable' }}-macos-x86_64"
          echo "  - rostoc-updates-${{ inputs.release_channel || 'stable' }}-windows-x86_64"
          echo "  - rostoc-updates-${{ inputs.release_channel || 'stable' }}-windows-i686"
          echo "  - rostoc-updates-${{ inputs.release_channel || 'stable' }}-linux-x86_64 (optional)"

      - name: Consolidate platform artifacts
        run: |
          set -euo pipefail

          mkdir -p macos-artifacts windows-artifacts linux-artifacts

          ROOT="artifacts"
          echo "[DEBUG] Initial ROOT: ${ROOT}"
          ls -la "${ROOT}" || true

          if [ -d "${ROOT}/updates" ]; then
            ROOT="${ROOT}/updates"
            echo "[DEBUG] Found updates subdirectory, ROOT now: ${ROOT}"
            ls -la "${ROOT}" || true
          fi

          echo "[DEBUG] Looking for platform directories in: ${ROOT}"
          ls -la "${ROOT}"/macos 2>/dev/null || echo "[DEBUG] No ${ROOT}/macos directory"
          ls -la "${ROOT}"/windows 2>/dev/null || echo "[DEBUG] No ${ROOT}/windows directory"
          ls -la "${ROOT}"/linux 2>/dev/null || echo "[DEBUG] No ${ROOT}/linux directory"

          echo "[DEBUG] Final ROOT directory structure:"
          ls -la "${ROOT}" || echo "[ERROR] ROOT directory ${ROOT} not found"

          echo ""
          echo "[DEBUG] Checking for platform subdirectories:"
          ls -la "${ROOT}/macos" 2>/dev/null || echo "[INFO] No ${ROOT}/macos directory"
          ls -la "${ROOT}/windows" 2>/dev/null || echo "[INFO] No ${ROOT}/windows directory"
          ls -la "${ROOT}/linux" 2>/dev/null || echo "[INFO] No ${ROOT}/linux directory"

          # Copy any macOS artifacts (all arches) into macos-artifacts
          if compgen -G "${ROOT}/macos/*" > /dev/null; then
            echo "[INFO] Found macOS artifacts, copying to macos-artifacts/"
            cp -R "${ROOT}"/macos/* macos-artifacts/
            ls -la macos-artifacts/
          else
            echo "::error::No macOS artifacts found in downloaded payloads"
            echo "[DEBUG] Listing ROOT to diagnose:"
            ls -la "${ROOT}" || true
            exit 1
          fi

          # Copy any Windows artifacts (all arches) into windows-artifacts
          if compgen -G "${ROOT}/windows/*" > /dev/null; then
            echo "[INFO] Found Windows artifacts, copying to windows-artifacts/"
            cp -R "${ROOT}"/windows/* windows-artifacts/
            ls -la windows-artifacts/
          else
            echo "::error::No Windows artifacts found in downloaded payloads"
            echo "[DEBUG] Listing ROOT to diagnose:"
            ls -la "${ROOT}" || true
            exit 1
          fi

          # Copy any Linux artifacts (all arches) into linux-artifacts (optional - failures expected)
          if compgen -G "${ROOT}/linux/*" > /dev/null; then
            cp -R "${ROOT}"/linux/* linux-artifacts/
            echo "[INFO] ✅ Linux artifacts found and consolidated"
            ls -la linux-artifacts/
          else
            echo "::notice::No Linux artifacts found (optional platform)"
          fi

      - name: Download pending notarizations metadata
        uses: actions/download-artifact@v4
        with:
          name: pending-notarizations
          path: private-src
        continue-on-error: true

      - name: Extract version
        id: extract-version
        run: |
          set -euo pipefail
          VERSION=$(jq -r '.version' private-src/src-tauri/tauri.conf.json)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "RELEASE_VERSION=${VERSION}" >> "$GITHUB_ENV"

      # NOTE: Local manifest generation removed - backend generates manifests dynamically
      # via database queries and serves them through API endpoints

      - name: Detect backend publish token
        id: detect-backend-token
        run: |
          if [ -n "${BACKEND_TOKEN:-}" ]; then
            echo "available=true" >> "$GITHUB_OUTPUT"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
            # shellcheck disable=SC2016
            echo '### ℹ️ Backend publish skipped' >> "$GITHUB_STEP_SUMMARY"
            # shellcheck disable=SC2016
            echo '\`ROSTOC_BACKEND_TOKEN\` not configured; skipping /api/updates/publish/.' >> "$GITHUB_STEP_SUMMARY"
          fi
        env:
          BACKEND_TOKEN: ${{ secrets.ROSTOC_BACKEND_TOKEN }}

      - name: Prepare backend publish payload
        if: steps.detect-backend-token.outputs.available == 'true'
        id: prepare-backend-payload
        run: |
          set -euo pipefail
          # NOTE: Removed --manifest and --releases args - build_backend_payload.py
          # now generates manifest_payload inline (backend generates manifests dynamically)
          python scripts/ci/build_backend_payload.py \
            --version "${{ env.RELEASE_VERSION }}" \
            --channel "${{ env.RELEASE_CHANNEL }}" \
            --build-sha "${{ env.BUILD_SHA }}" \
            --cdn-base "${{ env.DO_SPACES_CDN_URL }}" \
            --mac-root macos-artifacts \
            --windows-root windows-artifacts \
            --linux-root linux-artifacts
          echo "payload=publish-payload.json" >> "$GITHUB_OUTPUT"

      - name: Publish release metadata to backend
        if: steps.detect-backend-token.outputs.available == 'true'
        env:
          BACKEND_PUBLISH_TOKEN: ${{ secrets.ROSTOC_BACKEND_TOKEN }}
        run: |
          set -euo pipefail

          # Capture both response body and HTTP status
          response=$(curl -s -w "\n%{http_code}" -X POST "${{ env.BACKEND_PUBLISH_URL }}" \
            -H "Authorization: Bearer ${BACKEND_PUBLISH_TOKEN}" \
            -H "Content-Type: application/json" \
            --data-binary @"${{ steps.prepare-backend-payload.outputs.payload }}")

          status_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          if [[ "$status_code" != "200" ]] && [[ "$status_code" != "201" ]]; then
            echo "::error::Backend API returned HTTP $status_code"
            echo "Response body:"
            echo "$body"
            exit 1
          fi

          echo "Successfully published release metadata (HTTP $status_code)"

      - name: Upload manifest generation debug logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: manifest-debug-logs-${{ env.RELEASE_CHANNEL }}
          path: |
            macos-artifacts/
            windows-artifacts/
            linux-artifacts/
          retention-days: 7
          if-no-files-found: warn

  # NOTE: GitHub Pages publishing removed - backend now serves manifests dynamically
  # via API endpoints. Manifests are generated from database queries, not static files.
  # Desktop app and updater consume: https://api.rostoc.co/api/updates/<channel>/latest/<target>-<arch>/<version>/
